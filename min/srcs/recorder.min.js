export{config,mainDiv};import*as buttonClass from"./buttonClass.js";import*as utils from"./utils.js";let mainDiv,recordButton,pauseButton,downButton,isActive,interval,recorder,recStream,eventBlob,soundBlob,textData,jsData,cssData,totalTime,sliderBar,textTime,arrayValue,gifLoadingButton,config={position:"bottom-right",movable:!0,debug:!0,recordButtonColor:null,pauseButtonColor:null},isDragged=!1,isMenuOpen=!1,isPauseButtonCreated=!1,events=[],audioParts=[],encodingType="mp3",areRecordScriptsLoaded=!1,pauseReplayer=null,recorderState=null,encodingOver=!1;function loadJS(e,t,n){"use strict";var o,r=document.getElementsByTagName("script")[0],a=document.createElement("script");return"boolean"==typeof t&&(o=n,n=t,t=o),a.src=e,a.async=!n,r.parentNode.insertBefore(a,r),t&&"function"==typeof t&&(a.onload=t),a}function loadScripts(){isDragged||loadJS("./lib/rrweb/dist/rrweb.min.js",(function(){loadJS("./lib/web-audio-recorder/lib/WebAudioRecorder.js",(function(){areRecordScriptsLoaded=!0,launchRecord()}))}))}function computeTextTime(){let e=(sliderBar.value+"").split(".")[1];isUserComingBack=!0;let t=sliderBar.value/events.length*100;utils.logger("Computed percentage is "+t),sliderBar.style.background="linear-gradient(to right, #82CFD0 0%, #82CFD0 "+t+"%, #999999 "+t+"%, #999999 100%)",utils.logger("onInput works, value is "+sliderBar.value),utils.logger("Extracted decimal is "+e),null==e?arrayValue=sliderBar.value:e>=5&&Math.ceil(sliderBar.value)<=events.length?(arrayValue=Math.ceil(sliderBar.value),utils.logger("Because value is >= 5, taking next frame, arrayValue is "+arrayValue)):(arrayValue=Math.floor(sliderBar.value),utils.logger("Because value is < 5, taking previous frame, arrayValue is "+arrayValue)),textTime.innerHTML=computeTimeBetweenTwoFrames(events[arrayValue],events[0])+" / "+totalTime,pauseReplayer.pause(events[arrayValue].timestamp-events[0].timestamp)}function resumeRecord(){isDragged||(recorderState="RECORDING",pauseButton.style.backgroundImage="url('media/pause32.png')",document.getElementById("rrweb-pauseRecord").onclick=pauseRecord,isUserComingBack&&(console.log("I split from 0 to "+arrayValue),events=events.slice(0,arrayValue)),document.getElementById("rrweb-sliderDiv").style.visibility="hidden",recorder.startRecording(),isActive=rrweb.record({emit(e){events.push(e)}}),interval=setInterval((function(){utils.logger(events)}),1e3))}function pauseRecord(){let e;isDragged||(recorderState="PAUSED",isActive&&isActive(),clearInterval(interval),pauseButton.style.backgroundImage="url('media/resume32.png')",document.getElementById("rrweb-pauseRecord").onclick=resumeRecord,console.log("I set in pause"),events.length>2&&(totalTime=computeTimeBetweenTwoFrames(events[events.length-1],events[0]),pauseReplayer?document.getElementById("rrweb-sliderDiv").style.visibility="visible":(e=createBaseDiv("rrweb-sliderDiv"),textTime=document.createElement("p"),sliderBar=document.createElement("input"),sliderBar.id="rrweb-sliderBar",sliderBar.type="range",sliderBar.min="0",sliderBar.step="0.1",pauseReplayer=new rrweb.Replayer(events,{root:document.body}),pauseReplayer.enableInteract(),sliderBar.oninput=computeTextTime,e.appendChild(textTime),e.appendChild(sliderBar)),recorder.finishRecording(),textTime.innerHTML=totalTime+" / "+totalTime,sliderBar.max=events.length,sliderBar.value=events.length,sliderBar.style.background="linear-gradient(to right, #82CFD0 0%, #82CFD0 100%, #999999 100%, #999999 100%)",pauseReplayer.pause(events[events.length-1].timestamp,events[0].timestamp)))}function launchRecord(){isDragged||(recorderState="RECORDING",console.log("Recording has started! "),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then((function(e){utils.logger("getUserMedia() success, stream created, initializing WebAudioRecorder...");let t=new AudioContext;utils.logger("Format: 2 channel "+encodingType+" @ "+t.sampleRate/1e3+"kHz"),recStream=e;let n=t.createMediaStreamSource(e);areRecordScriptsLoaded&&(recorder=new WebAudioRecorder(n,{workerDir:"./lib/web-audio-recorder/lib/",encoding:encodingType,numChannel:2,onEncoderLoading:function(e,t){utils.logger("Loading "+t+" encoder...")},onEncoderLoaded:function(e,t){utils.logger(t+" encoder loaded")}}),recorder.onComplete=function(e,t){utils.logger("Encoding complete"),utils.logger(URL.createObjectURL(t)),audioParts.push(t),"STOPPED"==recorderState&&(encodingOver=!0,gifLoadingButton.hide(),displayDownButton())},recorder.setOptions({timeLimit:120,encodeAfterRecord:!0,ogg:{quality:.5},mp3:{bitRate:160}}),recorder.startRecording(),isActive=rrweb.record({emit(e){events.push(e)}}),interval=setInterval((function(){utils.logger(events)}),1e3),recordButton.style.backgroundColor="white",recordButton.style.backgroundImage="url('media/recording32.png')",recordButton.style.border="1px solid black",document.getElementById("rrweb-recordButton").onclick=stopRecord,openMenu())})))}function stopRecord(){isDragged||(recorderState="STOPPED",recordButton.style.backgroundColor="#d92027",recordButton.style.backgroundImage="url('media/camera32.png')",recordButton.style.border="none",document.getElementById("rrweb-recordButton").onclick=launchRecord,console.log("The recording has been stopped"),isActive&&isActive(),clearInterval(interval),openMenu(),recorder.finishRecording(),recStream.getAudioTracks()[0].stop(),eventBlob=new Blob([JSON.stringify(events)],{type:"application/json"}),0==encodingOver&&(gifLoadingButton=new buttonClass.Button(mainDiv,null,"rrweb-loadingDown","Your download is almost ready !","media/loading32.gif",recordButton),gifLoadingButton.createChildButton(),gifLoadingButton.setClickable(!1),gifLoadingButton.show()))}function displayDownButton(){audioParts.length>1?(utils.logger("Loading ConcatenateBlobs"),loadJS("./lib/concatenate-blob/ConcatenateBlobs.js",(function(){ConcatenateBlobs(audioParts,"audio/mpeg3",(function(e){soundBlob=e})),events.length>2&&(utils.changeMainDivSize(80,0),utils.logger("I can download the page"),downButton=new buttonClass.Button(mainDiv,downRecord,"rrweb-downRecord","Download your record","media/down32.png",recordButton),downButton.createChildButton(),downButton.show())}))):(utils.logger("No need to load ConcatenateBlobs"),soundBlob=audioParts[0],events.length>2&&(utils.changeMainDivSize(80,0),utils.logger("I can download the page"),downButton=new buttonClass.Button(mainDiv,downRecord,"rrweb-downRecord","Download your record","media/down32.png",recordButton),downButton.createChildButton(),downButton.show()))}function openMenu(){0==isDragged&&(isMenuOpen?(pauseButton.hide(),utils.changeMainDivSize(-80,0),isMenuOpen=!1):(utils.changeMainDivSize(80,0),isPauseButtonCreated?pauseButton.show():(pauseButton=new buttonClass.Button(mainDiv,pauseRecord,"rrweb-pauseRecord","Pause the record","media/pause32.png",recordButton),isPauseButtonCreated=!0,pauseButton.createChildButton()),isMenuOpen=!0))}function saveAs(e,t){const n=document.createElement("a");n.style.display="none",document.body.appendChild(n),n.href=window.URL.createObjectURL(new Blob([e],{type:"application/zip"})),n.setAttribute("download",t),n.click(),window.URL.revokeObjectURL(n.href),document.body.removeChild(n)}function readTextFile(e){var t=new XMLHttpRequest,n=!1;return t.open("GET",e,!1),t.onreadystatechange=function(){4===t.readyState&&(200!==t.status&&0!=t.status||(n=!0))},t.send(null),n?t.responseText:"error"}function addslashes(e){return e.replace(/\\/g,"\\\\").replace(/\u0008/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/'/g,"\\'").replace(/"/g,'\\"').replace(/\//g,"\\/")}function downRecord(){loadJS("./lib/jszip/dist/jszip.js",(function(){let e=new JSZip;textData=readTextFile("./download/download.html");let t=readTextFile("./download/download_end.html");jsData=readTextFile("./lib/rrweb/dist/rrweb.min.js"),cssData=readTextFile("./lib/rrweb/dist/rrweb.min.css"),console.log(addslashes(JSON.stringify(events)));let n='let events_string = "'+addslashes(JSON.stringify(events))+'";';textData+=n+t,utils.logger("Je mets les fichiers dans l'archive"),e.file("download.html",textData),e.file("js/rrweb.min.js",jsData),e.file("js/rrweb.min.css",cssData),e.file("data/events.json",eventBlob),e.file("data/sound.mp3",soundBlob),e.generateAsync({type:"blob"}).then((function(e){saveAs(e,"cours.zip")}))}))}function buttonPosition(e){config.position.search("bottom")>-1&&(e.style.bottom="50"),config.position.search("top")>-1&&(e.style.top="50"),config.position.search("middle")>-1&&(e.style.top="50"),config.position.search("-right")>-1&&(e.style.right="50"),config.position.search("-left")>-1&&(e.style.left="50")}function finishDragging(){isDragged=!1}function makeElementMovable(e){!function(e){utils.logger("Make element draggable");var t=0,n=0,o=0,r=0;let a=!0;document.getElementById(e.id+"header")?document.getElementById(e.id+"header").onmousedown=i:e.onmousedown=i;function i(e){isDragged=!0,(e=e||window.event).preventDefault(),o=e.clientX,r=e.clientY,document.onmouseup=l,document.onmousemove=s}function s(i){a=!1,(i=i||window.event).preventDefault(),t=o-i.clientX,n=r-i.clientY,o=i.clientX,r=i.clientY,e.offsetLeft-t>=0&&e.offsetLeft+70-t<window.screen.width&&e.offsetTop-n>=0&&e.offsetTop+70-n<window.screen.height&&(e.style.top=e.offsetTop-n+"px",e.style.left=e.offsetLeft-t+"px")}function l(){document.onmouseup=null,document.onmousemove=null,a?finishDragging():setTimeout(finishDragging,300),a=!0}}(e)}function createBaseDiv(e){var t=document.createElement("div");return t.classList.add("rr-block"),t.id=e,document.body.appendChild(t),t}function loadCss(e){var t=document.getElementsByTagName("head")[0],n=document.createElement("link");n.rel="stylesheet",n.type="text/css",n.href=e,n.media="all",t.appendChild(n),utils.logger("Loaded Css !")}window.onload=function(){utils.logger("Page has finished Loading, launching generic-rrweb-recorder"),mainDiv=createBaseDiv("rrweb-mainDivButton"),loadCss("media/style.css"),recordButton=new buttonClass.Button(mainDiv,loadScripts,"rrweb-recordButton","Start recording! ","media/camera32.png",null),recordButton.createMenuButton(),buttonPosition(mainDiv),utils.logger("Main Button has been created"),config.movable&&makeElementMovable(mainDiv)};